version: v1.0
name: publish-test-pypi
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1
blocks:
  - name: "Publish to Test PyPI"
    task:
      secrets:
        - name: v1/ci/kv/pypi/test.pypi.org
      jobs:
        - name: Upload
          commands:
            - checkout
            - sem-version python 3.11
            - pip install twine
            - artifact pull workflow artifacts
            - cd artifacts
            - ls *.tgz |xargs -n1 tar -xvf
            - cp sdist/*.tar.gz wheelhouse/ 2>/dev/null || true
            - twine upload --repository-url https://test.pypi.org/legacy/ wheelhouse/*
promotions:
  - name: "Publish to PyPI"
    pipeline_file: publish-pypi.yml