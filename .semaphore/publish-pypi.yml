version: v1.0
name: publish-pypi
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1
blocks:
  - name: "Publish to PyPI"
    dependencies: []
    task:
      jobs:
        - name: Upload
          commands:
            - checkout
            - . vault-setup
            - export TWINE_USERNAME=__token__
            - export TWINE_PASSWORD="$(vault kv get -format=json v1/ci/kv/pypi/pypi.org | jq -r '.data.data."confluent-kafka"')"
            - sem-version python 3.11
            - pip install twine
            - artifact pull workflow artifacts
            - cd artifacts
            - ls *.tgz |xargs -n1 tar -xvf
            - cp sdist/*.tar.gz wheelhouse/ 2>/dev/null || true
            - twine upload --non-interactive wheelhouse/*
  - name: "Verify PyPI Release"
    dependencies:
      - "Publish to PyPI"
    task:
      jobs:
        - name: Verify
          commands:
            - checkout
            - sem-version python 3.11
            - export CK_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
            - tools/test-released-wheels.sh $CK_VERSION