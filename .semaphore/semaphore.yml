version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1
execution_time_limit:
  hours: 3
global_job_config:
  env_vars:
    - name: LIBRDKAFKA_VERSION
      value: v2.13.0
  prologue:
    commands:
      - checkout
      - mkdir artifacts
blocks:
  - name: "Verify Test PyPI Access"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-amd64-1
      jobs:
        - name: Verify
          commands:
            - checkout
            - . vault-setup
            - export TWINE_USERNAME=__token__
            - export TWINE_PASSWORD="$(vault kv get -field=token v1/ci/kv/pypi/test.pypi.org)"
            - sem-version python 3.11
            - pip install twine build
            - python3 -m build -s
            - twine upload --repository-url https://test.pypi.org/legacy/ --non-interactive dist/*
            - echo "Vault setup and Test PyPI upload verified"
promotions:
  - name: "Publish to PyPI"
    pipeline_file: publish-pypi.yml
after_pipeline:
  task:
    agent:
      machine:
        type: s1-prod-ubuntu24-04-amd64-1
    jobs:
      - name: SonarQube
        commands:
          - checkout
          - artifact pull workflow coverage.xml
          - emit-sonarqube-data --run_only_sonar_scan