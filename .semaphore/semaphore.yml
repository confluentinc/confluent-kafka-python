version: v1.0
name: Python Pipeline
agent:
  machine:
    type: s1-prod-mac-m1
global_job_config:
  secrets:
    - name: vault_sem2_approle
  env_vars:
    - name: LIBRDKAFKA_VERSION
      value: v1.9.2-RC2
    - name: PYTHON_3_6
      value: "3.6.15"
    - name: PYTHON_3_7
      value: "3.7.13"
    - name: PYTHON_3_8
      value: "3.8.13"
    - name: PYTHON_3_9
      value: "3.9.13"
    - name: PYTHON_3_10
      value: "3.10.5"
blocks:
  - name: OSX x64
    run:
      when: "tag =~ '.*'"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-macos
      jobs:
        - name: Build
          commands:
            - cd $SEM_WORKSPACE
            - export HOME=$SEM_WORKSPACE
            - checkout
            - pyenv install -s ${PYTHON_3_6}
            - pyenv install -s ${PYTHON_3_7}
            - pyenv install -s ${PYTHON_3_8}
            - pyenv install -s ${PYTHON_3_9}
            - pyenv install -s ${PYTHON_3_10}
            # needed on the self-hosted agent
            - if [ ! -d ./tools ]; then cd $SEM_WORKSPACE/confluent-kafka-python; fi
            #- PIP_INSTALL_OPTIONS="--user" tools/wheels/build-wheels.sh "${LIBRDKAFKA_VERSION#v}" wheelhouse
            #- tar -czf wheelhouse-macOS-x64.tgz wheelhouse
            #- artifact push workflow wheelhouse-macOS-x64.tgz
            - mkdir -p ./wheelhouse && echo "test" > ./wheelhouse/test
            - .semaphore/upload_to_s3.sh wheelhouse "p-confluent-kafka-python__bld-semaphore__plat-osx__tag-${SEMAPHORE_GIT_TAG_NAME}__sha-${SEMAPHORE_GIT_SHA}__bid-${SEMAPHORE_WORKFLOW_ID}__"
  - name: OSX arm64
    run:
      when: "tag =~ '.*'"
    dependencies: []
    task:
      jobs:
        - name: Build
          commands:
            - cd $SEM_WORKSPACE
            - export HOME=$SEM_WORKSPACE
            - checkout
            - pyenv install -s ${PYTHON_3_8}
            - pyenv install -s ${PYTHON_3_9}
            - pyenv install -s ${PYTHON_3_10}
            # needed on the self-hosted agent
            - if [ ! -d ./tools ]; then cd $SEM_WORKSPACE/confluent-kafka-python; fi
            - PIP_INSTALL_OPTIONS="--user" tools/wheels/build-wheels.sh "${LIBRDKAFKA_VERSION#v}" wheelhouse
            - tar -czf wheelhouse-macOS-arm64.tgz wheelhouse
            - artifact push workflow wheelhouse-macOS-arm64.tgz
            #- .semaphore/upload_to_s3.sh wheelhouse "p-confluent-kafka-python__bld-semaphore__plat-osx__tag-${SEMAPHORE_GIT_TAG_NAME}__sha-${SEMAPHORE_GIT_SHA}__bid-${SEMAPHORE_WORKFLOW_ID}__"
  
  - name: Source package verification with Python 3 (OSX x64) +docs
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-macos
      env_vars:
        # openssl issue https://github.com/openssl/openssl/issues/18720
        - name: OPENSSL_CFLAGS
          value: "-Wno-error=implicit-function-declaration"
      jobs:
        - name: Build
          commands:
            - cd $SEM_WORKSPACE
            - export HOME=$SEM_WORKSPACE
            - checkout
            - pyenv install -s ${PYTHON_3_8}
            # needed on the self-hosted agent
            - if [ ! -d ./tools ]; then cd $SEM_WORKSPACE/confluent-kafka-python; fi
            - export INTERPRETER_VERSION=${PYTHON_3_8}
            # use a virtualenv
            - python3 -m venv _venv && source _venv/bin/activate
            - pip install -r docs/requirements.txt
            - pip install -r tests/requirements.txt
            - pip install -U protobuf
            - lib_dir=dest/runtimes/osx-x64/native
            - tools/wheels/install-librdkafka.sh "${LIBRDKAFKA_VERSION#v}" dest
            - export CFLAGS="-I${PWD}/dest/build/native/include"
            - export LDFLAGS="-L${PWD}/${lib_dir}"
            - export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$PWD/$lib_dir"
            - export DYLD_LIBRARY_PATH="$DYLD_LIBRARY_PATH:$PWD/$lib_dir"
            - python setup.py build && python setup.py install
            - python -m pytest --timeout 600 --ignore=dest
            - make docs